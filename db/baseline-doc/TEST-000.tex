\documentclass[DM,lsstdraft,authoryear,toc]{lsstdoc}
% lsstdoc documentation: https://lsst-texmf.lsst.io/lsstdoc.html

% Package imports go here.

% Local commands go here.
\newcommand{\opsim}{\texttt{OpSim}\,}
\newcommand{\socs}{\texttt{SOCS}\,}
\newcommand{\sched}{\texttt{Scheduler}\,}
\newcommand{\simsky}{\texttt{sims\_skybrightness}\,}
\newcommand{\magasq}{magnitude/arcsecond$^{2}$}

% To add a short-form title:
% \title[Short title]{Title}
\title{A New Baseline Operations Simulation}

% Optional subtitle
% \setDocSubtitle{A subtitle}

\author{%
Lynne Jones, 
Owen Boberg
}

\setDocRef{TEST-000}

\date{\today}

% Optional: name of the document's curator
% \setDocCurator{The Curator of this Document}

\setDocAbstract{%
We present an update to the baseline simulated survey, created using \opsim v4. The last operations simulation baseline simulated survey was minion\_1016, produced in 2016. This simulated survey was produced using \opsim v3. The changes include updates to the sky brightness, significant changes in the underlying opsim scheduling software, and the addition of new scheduler parameters. 
}

% Change history defined here.
% Order: oldest first.
% Fields: VERSION, DATE, DESCRIPTION, OWNER NAME.
% See LPM-51 for version number policy.
\setDocChangeRecord{%
  \addtohist{1}{YYY-MM-DD}{Unreleased.}{Lynne Jones}
}

\begin{document}

% Create the title page.
% Table of contents is added automatically with the "toc" class option.
\maketitle

\section{Overview}

The new \opsim v4 codebase makes significant changes when compared with the previous \opsim v3 software. These include: 
\begin{itemize}
\item Separation of the telemetry and telescope control simulation software from the scheduler software. These two packages are now called \texttt{Simulated Observatory Control System} (\socs) and \texttt{Scheduler}. 
\item Implement communication between \socs and \sched via DDS, a publish/subscribe protocol that will be used to communicate between various telescope control systems, including the scheduler code.
\item Update the slew time cost function, to add further flexibility to prioritize short slews.
\item Add an additional `cost' to changing the filter, to reduce the number of filter changes and in particular, fast filter changes.
\item Add a per-filter skybrightness calculation, using the \simsky package to calculate skybrightness values. This updates the skybrightness values to a model that includes a much higher fidelity twilight component and which has been validated against all-sky measurements from the LSST site. It also means that for each visit, the skybrightness limit is compared against the actual skybrightness estimate in the individual filter, instead of just against the $V$ band skybrightness as in \opsim v3.
\item Add the capability to restrict observations to a specified number of visits in a particular filter for a given field, per night. {\it E.g.}, limit visits for a given field to only 2 in $g$ band. This does not mean that no other visits to the same field will take place in the same night, but they would be in other filters which still have available groups. 
\item Add the capability to balance observations between different proposals, as a function of progress toward the total number of requested observations. {\it E.g.}, space the 180 visits per field for the South Celestial Pole proposal over the entire survey, at the same pace as the 825 visits per field for the Wide Fast Deep proposal, so all proposals span the entire survey.
\item Add the capability to add a per-proposal `airmass bonus`, which adds a preference for low-airmass observations to the observation ranking algorithm.
\item Add the capability to add a per-proposal `Hour Angle bonus`, which adds a preference for low-hour angle observations to the observation ranking algorithm. 
\end{itemize}


\begin{table}[htp]
\caption{Short list of simulated surveys illustrating \opsim changes.}
\begin{center}
\begin{tabular}{ l | l | l }
\opsim Run & Version & Summary \\
\hline
minion\_1016\_oldsky & \opsim v3 & Previous baseline, with old sky brightness values. \\
minion\_1016\_newsky &  & Previous baseline, reprocessed with new \simsky values.\\
\hline
astro-lsst-01\_2020 & \opsim v4  & All new features turned off (reproduce minion\_1016) \\
colossus\_2432 &  & Add time-balancing (TB).\\
colossus\_2328 &  & TB, Add restrict group visits (GV), and mild $HA$ bonus=0.05. \\
astro-lsst-01\_2016 &  & TB, GV, Add airmass bonus, $X$ bonus = 0.5 \\
astro-lsst-01\_2021 & & TB, GV, Add $HA$ bonus=0.5, $HA_{max}$=6 \\
astro-lsst-01\_2013 &  & TB, GV, Add $HA$ bonus=0.5, $HA_{max}$=3 \\
colossus\_2378 &  &  TB, GV, Add $HA$ bonus=0.8, $HA_{max}$=6 \\
astro-lsst-01\_2022 &   & TB, GV, Add $HA$ bonus=0.3, $HA_{max}$=3 \\
% colossus_2327 & & no time balancing, yes grouped visits
% colossus_2371 &  & no time balancing, no grouped visits
% colossus_2399 & & TB, GV, HA bonus 0.5 HAmax 6 
\end{tabular} 
\end{center}
\label{default}
\end{table}

\section{Summary of skybrightness changes}

One of the major updates between \opsim v3 and v4 was the introduction of a higher fidelity sky brightness model, including a model for twilight. 

The \opsim v3 model was based on \citet{1991PASP..103.1033K} (K\&S), which provides a $V$ band sky brightness based on field airmass, lunar distance, and lunar phase. The \opsim v3 model added varying color terms appropriate for different lunar phases, along with a significant (but constant) bump in skybrightness to 17.0 \magasq to model twilight. The $y$ band skybrightness was additionally modeled as constant at 17.3 \magasq during the night to reflect a lower sensitivity to lunar brightness.  The big jump in sky brightness during twilight, combined with sky brightness limits set in the configuration files, in practice typically prevented filters other than $z$ and $y$ band being used during twilight\footnote{Sometimes observations were taken with \opsim v3 which violated the specified sky brightness limits. These were usually due to calculating the sky brightness values prior to twilight and caching the results through the transition to twilight.}.

\opsim v4 uses the \simsky package \citep{2016SPIE.9910E..1AY}, which is based on the ESO SkyCalc Sky Model Calculator  (v1.4) for non-twilight sky brightness calculations with an added empirical twilight sky model. The sky brightness calculated for each field depends on the field alt/az position, the lunar alt/az, the lunar phase, the sun alt/az, and the filter of the observation. It includes contributions from emission from the upper and lower atmosphere, scattered starlight, scattered moonlight, and zodiacal light, along with an additional component of scattered sunlight during twilight (sun altitude between -11 and -20 degrees). The transitions into and out of twilight are much smoother, and notably, the twilight sky can be darker than the specified sky brightness limits even in $u$ band near zenith. Thus in runs produced with \opsim v4.1, sometimes observations in $u$, $g$, $r$ or $i$ are taken during twilight due to a simple hard-limit on the sky brightness. It is possible to set these limits strictly enough to avoid this, however then some non-twilight observations at higher airmass, smaller distances to the moon, or at greater lunar phases, will also be ruled out, leaving significantly less flexibility in scheduling `normal' observations. In the future, the hard-limit will be replaced by a soft-constraint bonus, such as a preference for observations closer to the theoretical darkest sky brightness possible at a given time. 

%https://community.lsst.org/t/comparing-eso-sky-model-to-current-opsim-sky-values/489/2
%https://github.com/rhiannonlynne/notebooks/blob/master/skybright%20changes.ipynb

To evaluate the effect of changing the sky brightness model, we first reprocessed the previous baseline, minion\_1016, using \simsky. 



skybrightness reprocessing in minion\_1016

similar skybrightness values in newer runs



effects skybrightness itself, and also derived values; most strongly, affects total effective time of the survey / coadded depth, but also proper motion and parallax errors at faint ($r=24$) end.

\section{Effect of changing the slewtime and filter change cost functions}

compare minion\_1016 with astro-lsst-01\_2020 (slewtime histograms and filter change numbers)

the actual slew time will depend on further changing the next visit ranking via the bonus values

\section{Choosing the bonus values} 

compare X bonus vs. HA bonus

compare HA bonus values
 
compare HA max values

\section{New baseline survey recommention}

srd values pass

other big changes from minion\_1016

\section{Reproducibility of new baseline survey and its evaluation}

config files
results of evaluation
how they were produced
where they can be found online

% Include all the relevant bib files.
% https://lsst-texmf.lsst.io/lsstdoc.html#bibliographies
\bibliography{lsst,lsst-dm,refs_ads,refs,books}

\end{document}
